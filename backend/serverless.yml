service: trueprofit-backend
frameworkVersion: "4"

provider:
    name: aws
    region: us-east-1
    stage: ${opt:stage, 'dev'}

    runtime: provided.al2
    architecture: arm64
    environment:
        APP_STAGE: ${sls:stage}

        TRANSACTIONS_TABLE: TrueProfitTransactions-${sls:stage}
        INTEGRATIONS_TABLE: TrueProfitIntegrations-${sls:stage}
        OAUTH_STATE_TABLE: TrueProfitOAuthState-${sls:stage}
        SHOP_TO_USER_TABLE: TrueProfitShopToUser-${sls:stage}
        SHOPIFY_WEBHOOK_DEDUPE_TABLE: TrueProfitShopifyWebhookDedupe-${sls:stage}
        USERS_TABLE: TrueProfitUsers-${sls:stage}

        SHOPIFY_API_KEY: ${env:SHOPIFY_API_KEY}
        SHOPIFY_API_SECRET: ${env:SHOPIFY_API_SECRET}
        SHOPIFY_API_VERSION: ${env:SHOPIFY_API_VERSION}
        SHOPIFY_SCOPES: read_orders
        SHOPIFY_EVENTBRIDGE_SOURCE_ARN: ${env:SHOPIFY_EVENTBRIDGE_SOURCE_ARN}
        SHOPIFY_PARTNER_BUS_ARN: ${env:SHOPIFY_PARTNER_BUS_ARN}

        TOKEN_ENC_KEY_B64: ${env:TOKEN_ENC_KEY_B64}
        FRONTEND_BASE_URL:
            Fn::Sub:
                - https://${CloudFrontDomain}/
                - CloudFrontDomain: ${self:custom.cloudFrontDomain}

        # Cognito values for Lambdas (helpful for building hosted UI URLs etc.)
        COGNITO_CLIENT_ID:
            Ref: CognitoUserPoolClient
        COGNITO_ISSUER_URL:
            Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}

        GLUE_DATABASE: !Sub "trueprofit_analytics_${sls:stage}"
        DAILY_METRICS_TABLE: "daily_metrics"
        DAILY_METRICS_PREFIX: "daily_metrics/"
        ATHENA_WORKGROUP: !Sub "trueprofit-${sls:stage}"
        ATHENA_DATABASE: !Sub "trueprofit_analytics_${sls:stage}"
        ATHENA_OUTPUT_S3: !Sub "s3://trueprofit-analytics-${sls:stage}-${AWS::AccountId}/athena-results/"
        ANALYTICS_BUCKET: !Sub "trueprofit-analytics-${sls:stage}-${AWS::AccountId}"
        BEDROCK_MODEL_ID: ${env:BEDROCK_MODEL_ID, "anthropic.claude-3-5-sonnet-20240620-v1:0"}
        NLQ_MAX_DAYS: ${env:NLQ_MAX_DAYS, "90"}
        SHOP_TO_USER_GSI_USERSUB: "GSI_UserSub"
        NLQ_CACHE_TABLE: "TrueProfitNLQCache-${sls:stage}"
        NLQ_CACHE_TTL_SECONDS: ${env:NLQ_CACHE_TTL_SECONDS, "600"}

    httpApi:
        cors: true
        authorizers:
            cognitoJwt:
                type: jwt
                identitySource: "$request.header.Authorization"
                issuerUrl:
                    Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}
                audience:
                    - Ref: CognitoUserPoolClient

    iam:
        role:
            statements:
                # DynamoDB: tables + indexes
                - Effect: Allow
                  Action:
                      - dynamodb:GetItem
                      - dynamodb:PutItem
                      - dynamodb:UpdateItem
                      - dynamodb:DeleteItem
                      - dynamodb:Query
                      - dynamodb:Scan
                      - dynamodb:BatchGetItem
                  Resource:
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitTransactions-${sls:stage}
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitTransactions-${sls:stage}/index/*
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitIntegrations-${sls:stage}
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitIntegrations-${sls:stage}/index/*
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitOAuthState-${sls:stage}
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitOAuthState-${sls:stage}/index/*
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitShopToUser-${sls:stage}
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitShopToUser-${sls:stage}/index/*
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitShopifyWebhookDedupe-${sls:stage}
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitShopifyWebhookDedupe-${sls:stage}/index/*
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitUsers-${sls:stage}
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitUsers-${sls:stage}/index/*
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitNLQCache-${sls:stage}
                      - Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/TrueProfitNLQCache-${sls:stage}/index/*
                # SQS polling permissions for both worker queues
                - Effect: Allow
                  Action:
                      - sqs:ReceiveMessage
                      - sqs:DeleteMessage
                      - sqs:GetQueueAttributes
                      - sqs:ChangeMessageVisibility
                  Resource:
                      - Fn::GetAtt: [ShopifyOrdersQueue, Arn]
                      - Fn::GetAtt: [ShopifyRefundsQueue, Arn]

                # SNS (for per-user topics / publishing)
                - Effect: Allow
                  Action:
                      - sns:CreateTopic
                      - sns:Subscribe
                      - sns:Publish
                      - sns:ListSubscriptionsByTopic
                  Resource: "*"

                # SSM Parameter Store (for reading Cognito domain prefix)
                - Effect: Allow
                  Action:
                      - ssm:GetParameter
                      - ssm:GetParameters
                      - ssm:GetParametersByPath
                  Resource:
                      - Fn::Sub: arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/trueprofit/*

                # Athena execute + read results
                - Effect: Allow
                  Action:
                      - athena:StartQueryExecution
                      - athena:GetQueryExecution
                      - athena:GetQueryResults
                  Resource: "*"

                # Glue schema fetch
                - Effect: Allow
                  Action:
                      - glue:GetDatabase
                      - glue:GetTable
                      - glue:GetTables
                      - glue:GetPartitions
                  Resource: "*"

                # S3 read data + write Athena results
                - Effect: Allow
                  Action:
                      - s3:GetBucketLocation
                      - s3:ListBucket
                  Resource:
                      - !Sub "arn:aws:s3:::trueprofit-analytics-${sls:stage}-${AWS::AccountId}"

                - Effect: Allow
                  Action:
                      - s3:GetObject
                      - s3:PutObject
                  Resource:
                      - !Sub "arn:aws:s3:::trueprofit-analytics-${sls:stage}-${AWS::AccountId}/*"

                - Effect: Allow
                  Action:
                      - bedrock:InvokeModel
                  Resource: "*"
package:
    individually: true

custom:
    # Import CloudFront domain from frontend stack export
    cloudFrontDomain:
        Fn::ImportValue: TrueProfit-CloudFrontDomainName-${sls:stage}

    # Cognito Hosted UI domain prefix
    cognitoDomainPrefix: trueprofit-${sls:stage}-${aws:accountId}

functions:
    health:
        handler: bootstrap
        package:
            artifact: dist/health.zip
        events:
            - httpApi:
                  path: /health
                  method: GET

    transactions:
        handler: bootstrap
        package:
            artifact: dist/transactions.zip
        events:
            - httpApi:
                  path: /transactions
                  method: GET
                  authorizer:
                      name: cognitoJwt
            - httpApi:
                  path: /transactions
                  method: POST
                  authorizer:
                      name: cognitoJwt

    summaryMonthly:
        handler: bootstrap
        package:
            artifact: dist/summary.zip
        events:
            - httpApi:
                  path: /summary/monthly
                  method: GET
                  authorizer:
                      name: cognitoJwt

    shopify:
        handler: bootstrap
        package:
            artifact: dist/shopify.zip
        events:
            - httpApi:
                  path: /integrations/shopify/connect
                  method: GET
                  authorizer:
                      name: cognitoJwt
            - httpApi:
                  path: /integrations/shopify/callback
                  method: GET
            - httpApi:
                  path: /integrations/shopify/shops
                  method: GET
                  authorizer:
                      name: cognitoJwt
            - httpApi:
                  path: /integrations/shopify/shops
                  method: DELETE
                  authorizer:
                      name: cognitoJwt
            - httpApi:
                  path: /integrations/shopify/sync
                  method: POST
                  authorizer:
                      name: cognitoJwt
            - httpApi:
                  path: /integrations/shopify/eventbridge/subscribe
                  method: POST
                  authorizer:
                      name: cognitoJwt

    shopifyOrdersWorker:
        handler: bootstrap
        package:
            artifact: dist/shopify-orders-worker.zip
        events:
            - sqs:
                  arn:
                      Fn::GetAtt: [ShopifyOrdersQueue, Arn]
                  batchSize: 5
                  functionResponseType: ReportBatchItemFailures
                  filterPatterns:
                      - body:
                            detail:
                                metadata:
                                    X-Shopify-Topic:
                                        - prefix: "orders/create"

    shopifyRefundsWorker:
        handler: bootstrap
        package:
            artifact: dist/shopify-refunds-worker.zip
        events:
            - sqs:
                  arn:
                      Fn::GetAtt: [ShopifyRefundsQueue, Arn]
                  batchSize: 5
                  functionResponseType: ReportBatchItemFailures
                  filterPatterns:
                      - body:
                            detail:
                                metadata:
                                    X-Shopify-Topic:
                                        - prefix: "refunds/create"

    shopifyEmailer:
        handler: bootstrap
        package:
            artifact: dist/shopify-emailer.zip
        events:
            - sqs:
                  arn:
                      Fn::GetAtt: [ShopifyAlertsQueue, Arn]
                  batchSize: 5

    ask:
        handler: bootstrap
        package:
            artifact: dist/ask.zip
        environment:
            GLUE_DATABASE: ${self:provider.environment.GLUE_DATABASE}
            DAILY_METRICS_TABLE: ${self:provider.environment.DAILY_METRICS_TABLE}
            ATHENA_DATABASE: ${self:provider.environment.ATHENA_DATABASE}
            ATHENA_WORKGROUP: ${self:provider.environment.ATHENA_WORKGROUP}
            ATHENA_OUTPUT_S3: ${self:provider.environment.ATHENA_OUTPUT_S3}
            BEDROCK_MODEL_ID: ${self:provider.environment.BEDROCK_MODEL_ID}
            NLQ_MAX_DAYS: ${self:provider.environment.NLQ_MAX_DAYS}
        events:
            - httpApi:
                  path: /ask
                  method: post
                  authorizer:
                      name: cognitoJwt

    etlDailyMetrics:
        handler: bootstrap
        package:
            artifact: dist/etl-daily-metrics.zip
        environment:
            SHOP_TO_USER_TABLE: ${self:provider.environment.SHOP_TO_USER_TABLE}
            SHOP_TO_USER_GSI_USERSUB: ${self:provider.environment.SHOP_TO_USER_GSI_USERSUB}
            ANALYTICS_BUCKET: ${self:provider.environment.ANALYTICS_BUCKET}
            DAILY_METRICS_PREFIX: ${self:provider.environment.DAILY_METRICS_PREFIX}
            ETL_TIMEZONE: ${env:ETL_TIMEZONE, "Asia/Ho_Chi_Minh"}
        events:
            - schedule:
                  rate: cron(10 17 * * ? *)
                  enabled: true

    repairDailyMetricsPartitions:
        handler: bootstrap
        package:
            artifact: dist/repair-partitions.zip
        environment:
            ATHENA_DATABASE: ${self:provider.environment.ATHENA_DATABASE}
            ATHENA_WORKGROUP: ${self:provider.environment.ATHENA_WORKGROUP}
            ATHENA_OUTPUT_S3: ${self:provider.environment.ATHENA_OUTPUT_S3}
            REPAIR_TABLE_NAME: "daily_metrics"
        events:
            - schedule:
                  rate: cron(20 17 * * ? *)
                  enabled: true

resources:
    Resources:
        # ----------------------------
        # DynamoDB
        # ----------------------------
        TransactionsTable:
            Type: AWS::DynamoDB::Table
            Properties:
                TableName: ${self:provider.environment.TRANSACTIONS_TABLE}
                BillingMode: PAY_PER_REQUEST
                AttributeDefinitions:
                    - AttributeName: PK
                      AttributeType: S
                    - AttributeName: SK
                      AttributeType: S
                    - AttributeName: GSI1PK
                      AttributeType: S
                    - AttributeName: GSI1SK
                      AttributeType: S
                KeySchema:
                    - AttributeName: PK
                      KeyType: HASH
                    - AttributeName: SK
                      KeyType: RANGE
                GlobalSecondaryIndexes:
                    - IndexName: GSI1
                      KeySchema:
                          - AttributeName: GSI1PK
                            KeyType: HASH
                          - AttributeName: GSI1SK
                            KeyType: RANGE
                      Projection:
                          ProjectionType: ALL

        IntegrationsTable:
            Type: AWS::DynamoDB::Table
            Properties:
                TableName: ${self:provider.environment.INTEGRATIONS_TABLE}
                BillingMode: PAY_PER_REQUEST
                AttributeDefinitions:
                    - AttributeName: PK
                      AttributeType: S
                    - AttributeName: SK
                      AttributeType: S
                KeySchema:
                    - AttributeName: PK
                      KeyType: HASH
                    - AttributeName: SK
                      KeyType: RANGE

        OAuthStateTable:
            Type: AWS::DynamoDB::Table
            Properties:
                TableName: ${self:provider.environment.OAUTH_STATE_TABLE}
                BillingMode: PAY_PER_REQUEST
                AttributeDefinitions:
                    - AttributeName: State
                      AttributeType: S
                KeySchema:
                    - AttributeName: State
                      KeyType: HASH
                TimeToLiveSpecification:
                    AttributeName: ExpiresAtEpoch
                    Enabled: true

        ShopToUserTable:
            Type: AWS::DynamoDB::Table
            Properties:
                TableName: ${self:provider.environment.SHOP_TO_USER_TABLE}
                BillingMode: PAY_PER_REQUEST
                AttributeDefinitions:
                    - AttributeName: PK
                      AttributeType: S
                    - AttributeName: SK
                      AttributeType: S
                    - AttributeName: UserSub
                      AttributeType: S
                KeySchema:
                    - AttributeName: PK
                      KeyType: HASH
                    - AttributeName: SK
                      KeyType: RANGE
                GlobalSecondaryIndexes:
                    - IndexName: GSI_UserSub
                      KeySchema:
                          - AttributeName: UserSub
                            KeyType: HASH
                      Projection:
                          ProjectionType: ALL
        ShopifyWebhookDedupeTable:
            Type: AWS::DynamoDB::Table
            Properties:
                TableName: ${self:provider.environment.SHOPIFY_WEBHOOK_DEDUPE_TABLE}
                BillingMode: PAY_PER_REQUEST
                AttributeDefinitions:
                    - AttributeName: PK
                      AttributeType: S
                KeySchema:
                    - AttributeName: PK
                      KeyType: HASH
                TimeToLiveSpecification:
                    AttributeName: ExpiresAt
                    Enabled: true

        UsersTable:
            Type: AWS::DynamoDB::Table
            Properties:
                TableName: ${self:provider.environment.USERS_TABLE}
                BillingMode: PAY_PER_REQUEST
                AttributeDefinitions:
                    - AttributeName: PK
                      AttributeType: S
                KeySchema:
                    - AttributeName: PK
                      KeyType: HASH

        # ----------------------------
        # SQS
        # ----------------------------
        ShopifyAlertsDLQ:
            Type: AWS::SQS::Queue
            Properties:
                QueueName: trueprofit-shopify-alerts-dlq-${sls:stage}

        ShopifyAlertsQueue:
            Type: AWS::SQS::Queue
            Properties:
                QueueName: trueprofit-shopify-alerts-${sls:stage}
                VisibilityTimeout: 60
                RedrivePolicy:
                    deadLetterTargetArn:
                        Fn::GetAtt: [ShopifyAlertsDLQ, Arn]
                    maxReceiveCount: 5

        ShopifyOrdersDLQ:
            Type: AWS::SQS::Queue
            Properties:
                QueueName: trueprofit-shopify-orders-dlq-${sls:stage}

        ShopifyOrdersQueue:
            Type: AWS::SQS::Queue
            Properties:
                QueueName: trueprofit-shopify-orders-${sls:stage}
                VisibilityTimeout: 120
                RedrivePolicy:
                    deadLetterTargetArn:
                        Fn::GetAtt: [ShopifyOrdersDLQ, Arn]
                    maxReceiveCount: 5

        ShopifyRefundsDLQ:
            Type: AWS::SQS::Queue
            Properties:
                QueueName: trueprofit-shopify-refunds-dlq-${sls:stage}

        ShopifyRefundsQueue:
            Type: AWS::SQS::Queue
            Properties:
                QueueName: trueprofit-shopify-refunds-${sls:stage}
                VisibilityTimeout: 120
                RedrivePolicy:
                    deadLetterTargetArn:
                        Fn::GetAtt: [ShopifyRefundsDLQ, Arn]
                    maxReceiveCount: 5

        # ----------------------------
        # EventBridge partner bus -> SQS
        # ----------------------------
        ShopifyPartnerBusToAlertsQueueRule:
            Type: AWS::Events::Rule
            Properties:
                Name: trueprofit-shopify-alerts-${sls:stage}
                EventBusName: ${self:provider.environment.SHOPIFY_PARTNER_BUS_ARN}
                EventPattern:
                    detail-type:
                        - shopifyWebhook
                    source:
                        - prefix: aws.partner/shopify.com
                    detail:
                        metadata:
                            X-Shopify-Topic:
                                - prefix: "orders/create"
                                - prefix: "refunds/create"
                Targets:
                    - Arn:
                          Fn::GetAtt: [ShopifyAlertsQueue, Arn]
                      Id: ShopifyAlertsQueueTarget

        ShopifyPartnerBusToOrdersRule:
            Type: AWS::Events::Rule
            Properties:
                Name: trueprofit-shopify-orders-${sls:stage}
                EventBusName: ${self:provider.environment.SHOPIFY_PARTNER_BUS_ARN}
                EventPattern:
                    detail-type:
                        - shopifyWebhook
                    source:
                        - prefix: aws.partner/shopify.com
                    detail:
                        metadata:
                            X-Shopify-Topic:
                                - prefix: "orders/create"
                Targets:
                    - Arn:
                          Fn::GetAtt: [ShopifyOrdersQueue, Arn]
                      Id: OrdersQueueTarget

        ShopifyPartnerBusToRefundsRule:
            Type: AWS::Events::Rule
            Properties:
                Name: trueprofit-shopify-refunds-${sls:stage}
                EventBusName: ${self:provider.environment.SHOPIFY_PARTNER_BUS_ARN}
                EventPattern:
                    detail-type:
                        - shopifyWebhook
                    source:
                        - prefix: aws.partner/shopify.com
                    detail:
                        metadata:
                            X-Shopify-Topic:
                                - prefix: "refunds/creat"
                Targets:
                    - Arn:
                          Fn::GetAtt: [ShopifyRefundsQueue, Arn]
                      Id: RefundsQueueTarget

        ShopifyAlertsQueuePolicy:
            Type: AWS::SQS::QueuePolicy
            Properties:
                Queues:
                    - Ref: ShopifyAlertsQueue
                PolicyDocument:
                    Version: "2012-10-17"
                    Statement:
                        - Sid: AllowEventBridgeSendMessage
                          Effect: Allow
                          Principal:
                              Service: events.amazonaws.com
                          Action: sqs:SendMessage
                          Resource:
                              Fn::GetAtt: [ShopifyAlertsQueue, Arn]
                          Condition:
                              ArnEquals:
                                  aws:SourceArn:
                                      Fn::GetAtt: [ShopifyPartnerBusToAlertsQueueRule, Arn]

        ShopifyOrdersQueuePolicy:
            Type: AWS::SQS::QueuePolicy
            Properties:
                Queues:
                    - Ref: ShopifyOrdersQueue
                PolicyDocument:
                    Version: "2012-10-17"
                    Statement:
                        - Sid: AllowEventBridgeSendOrders
                          Effect: Allow
                          Principal:
                              Service: events.amazonaws.com
                          Action: sqs:SendMessage
                          Resource:
                              Fn::GetAtt: [ShopifyOrdersQueue, Arn]
                          Condition:
                              ArnEquals:
                                  aws:SourceArn:
                                      Fn::GetAtt: [ShopifyPartnerBusToOrdersRule, Arn]

        ShopifyRefundsQueuePolicy:
            Type: AWS::SQS::QueuePolicy
            Properties:
                Queues:
                    - Ref: ShopifyRefundsQueue
                PolicyDocument:
                    Version: "2012-10-17"
                    Statement:
                        - Sid: AllowEventBridgeSendRefunds
                          Effect: Allow
                          Principal:
                              Service: events.amazonaws.com
                          Action: sqs:SendMessage
                          Resource:
                              Fn::GetAtt: [ShopifyRefundsQueue, Arn]
                          Condition:
                              ArnEquals:
                                  aws:SourceArn:
                                      Fn::GetAtt: [ShopifyPartnerBusToRefundsRule, Arn]

        # ----------------------------
        # Cognito
        # ----------------------------
        CognitoUserPool:
            Type: AWS::Cognito::UserPool
            Properties:
                UserPoolName: trueprofit-userpool-${sls:stage}
                UsernameAttributes: [email]
                AutoVerifiedAttributes: [email]
                Policies:
                    PasswordPolicy:
                        MinimumLength: 8
                        RequireLowercase: true
                        RequireUppercase: true
                        RequireNumbers: true
                        RequireSymbols: false

        CognitoDomainPrefix:
            Type: AWS::SSM::Parameter
            Properties:
                Name: /trueprofit/${sls:stage}/cognitoDomainPrefix
                Type: String
                Value: ${self:custom.cognitoDomainPrefix}

        CognitoUserPoolDomain:
            Type: AWS::Cognito::UserPoolDomain
            Properties:
                UserPoolId:
                    Ref: CognitoUserPool
                Domain: ${self:custom.cognitoDomainPrefix}
                ManagedLoginVersion: 2

        CognitoUserPoolClient:
            Type: AWS::Cognito::UserPoolClient
            Properties:
                UserPoolId:
                    Ref: CognitoUserPool
                ClientName: trueprofit-client-${sls:stage}
                GenerateSecret: false

                AllowedOAuthFlowsUserPoolClient: true
                AllowedOAuthFlows:
                    - code
                SupportedIdentityProviders:
                    - COGNITO

                AllowedOAuthScopes:
                    - openid
                    - email
                    - profile

                # CloudFront callback/logout imported from frontend stack exports
                CallbackURLs:
                    - Fn::Sub:
                          - https://${CloudFrontDomain}/callback
                          - CloudFrontDomain: ${self:custom.cloudFrontDomain}
                    - http://localhost:5173/callback

                LogoutURLs:
                    - Fn::Sub:
                          - https://${CloudFrontDomain}/
                          - CloudFrontDomain: ${self:custom.cloudFrontDomain}
                    - http://localhost:5173/

        CognitoManagedLoginBrandingDefault:
            Type: AWS::Cognito::ManagedLoginBranding
            Properties:
                UserPoolId:
                    Ref: CognitoUserPool
                ClientId:
                    Ref: CognitoUserPoolClient
                UseCognitoProvidedValues: true

        # ----------------------------
        # SSM Parameters
        # ----------------------------
        ApiBaseUrlParameter:
            Type: AWS::SSM::Parameter
            Properties:
                Name: /trueprofit/${sls:stage}/apiBaseUrl
                Type: String
                Value:
                    Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com

        # S3 Analytic
        AnalyticsBucket:
            Type: AWS::S3::Bucket
            Properties:
                BucketName: ${self:provider.environment.ANALYTICS_BUCKET}
                PublicAccessBlockConfiguration:
                    BlockPublicAcls: true
                    IgnorePublicAcls: true
                    BlockPublicPolicy: true
                    RestrictPublicBuckets: true

        # Athena query results folder (prefix initializer)
        AthenaResultsPrefix:
            Type: AWS::S3::BucketPolicy
            Properties:
                Bucket: !Ref AnalyticsBucket
                PolicyDocument:
                    Version: "2012-10-17"
                    Statement:
                        - Sid: AllowAccessForAthenaQueries
                          Effect: Allow
                          Principal:
                              Service: athena.amazonaws.com
                          Action:
                              - "s3:PutObject"
                              - "s3:GetBucketLocation"
                              - "s3:GetObject"
                              - "s3:ListBucket"
                          Resource:
                              - !Sub "arn:aws:s3:::trueprofit-analytics-${sls:stage}-${AWS::AccountId}"
                              - !Sub "arn:aws:s3:::trueprofit-analytics-${sls:stage}-${AWS::AccountId}/*"

        # Glue Database
        TrueProfitGlueDatabase:
            Type: AWS::Glue::Database
            Properties:
                CatalogId: !Ref AWS::AccountId
                DatabaseInput:
                    Name: !Sub "trueprofit_analytics_${sls:stage}"
                    Description: "TrueProfit analytics Glue database (used by Athena + NLQ)"

        DailyMetricsGlueTable:
            Type: AWS::Glue::Table
            DependsOn: TrueProfitGlueDatabase
            Properties:
                CatalogId: !Ref AWS::AccountId
                DatabaseName: !Ref TrueProfitGlueDatabase
                TableInput:
                    Name: "daily_metrics"
                    Description: "Daily aggregated metrics per shop (Parquet)"
                    TableType: "EXTERNAL_TABLE"
                    Parameters:
                        classification: "parquet"
                        EXTERNAL: "TRUE"
                    PartitionKeys:
                        - Name: "dt"
                          Type: "date"
                        - Name: "shop_id"
                          Type: "string"
                    StorageDescriptor:
                        Location: !Sub "s3://trueprofit-analytics-${sls:stage}-${AWS::AccountId}/daily_metrics/"
                        Columns:
                            - Name: "merchant_id"
                              Type: "string"
                            - Name: "metric_date"
                              Type: "string"
                            - Name: "gross_revenue"
                              Type: "double"
                            - Name: "net_revenue"
                              Type: "double"
                            - Name: "product_costs"
                              Type: "double"
                            - Name: "marketing_costs"
                              Type: "double"
                            - Name: "fulfillment_costs"
                              Type: "double"
                            - Name: "processing_fees"
                              Type: "double"
                            - Name: "other_costs"
                              Type: "double"
                        InputFormat: "org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat"
                        OutputFormat: "org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat"
                        Compressed: false
                        NumberOfBuckets: -1
                        StoredAsSubDirectories: false
                        SerdeInfo:
                            SerializationLibrary: "org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe"
                            Parameters:
                                serialization.format: "1"

        TrueProfitAthenaWorkGroup:
            Type: AWS::Athena::WorkGroup
            Properties:
                Name: ${self:provider.environment.ATHENA_WORKGROUP}
                Description: !Sub "TrueProfit Athena workgroup (${sls:stage})"
                State: ENABLED
                WorkGroupConfiguration:
                    EnforceWorkGroupConfiguration: true
                    PublishCloudWatchMetricsEnabled: true
                    ResultConfiguration:
                        OutputLocation: !Sub "s3://trueprofit-analytics-${sls:stage}-${AWS::AccountId}/athena-results/"

        NLQCacheTable:
            Type: AWS::DynamoDB::Table
            Properties:
                BillingMode: PAY_PER_REQUEST
                TableName: ${self:provider.environment.NLQ_CACHE_TABLE}
                AttributeDefinitions:
                    - AttributeName: PK
                      AttributeType: S
                    - AttributeName: SK
                      AttributeType: S
                KeySchema:
                    - AttributeName: PK
                      KeyType: HASH
                    - AttributeName: SK
                      KeyType: RANGE
                TimeToLiveSpecification:
                    AttributeName: ExpiresAt
                    Enabled: true

    Outputs:
        CognitoUserPoolId:
            Value:
                Ref: CognitoUserPool
            Export:
                Name: TrueProfit-CognitoUserPoolId-${sls:stage}
        CognitoUserPoolClientId:
            Value:
                Ref: CognitoUserPoolClient
            Export:
                Name: TrueProfit-CognitoUserPoolClientId-${sls:stage}
        CognitoHostedDomainURL:
            Value:
                Fn::Sub: https://${self:custom.cognitoDomainPrefix}.auth.${AWS::Region}.amazoncognito.com
            Export:
                Name: TrueProfit-CognitoHostedDomainURL-${sls:stage}

        ImportedCloudFrontDomain:
            Value: ${self:custom.cloudFrontDomain}
        ApiBaseUrl:
            Value:
                Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com
            Export:
                Name: TrueProfit-ApiBaseUrl-${sls:stage}
